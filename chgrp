#!/usr/bin/env python3
import os
import sys
import grp

# --- parse arguments ---
args = sys.argv[1:]
recursive = False
follow_symlinks = True
group_str = None
files = []

i = 0
while i < len(args):
    a = args[i]
    if a == "-R":
        recursive = True
    elif a == "-h":
        follow_symlinks = False
    elif a in ("-H", "-L", "-P"):
        follow_symlinks = a != "-P"
    elif not group_str:
        group_str = a
    else:
        files.append(a)
    i += 1

if not group_str or not files:
    print("Usage: chgrp [-R] [-h|-H|-L|-P] group file...", file=sys.stderr)
    sys.exit(1)

# --- resolve group ---
try:
    gid = int(group_str)
except ValueError:
    try:
        gid = grp.getgrnam(group_str).gr_gid
    except KeyError:
        print(f"chgrp: invalid group '{group_str}'", file=sys.stderr)
        sys.exit(1)

# --- recursive processing ---
def process_file(path):
    try:
        # use current uid to preserve owner
        uid = os.lstat(path).st_uid
        os.chown(path, uid, gid, follow_symlinks=follow_symlinks)
        if recursive and os.path.isdir(path):
            for entry in os.listdir(path):
                child = os.path.join(path, entry)
                process_file(child)
    except Exception as e:
        print(f"chgrp: cannot change group of '{path}': {e}", file=sys.stderr)

# --- apply to files ---
for f in files:
    process_file(f)
